name: build
on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ 'main', 'release/**' ]

permissions:
  contents: read # for actions/checkout to fetch code

jobs:
  test-linux-amd64:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: Setup Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
      with:
        go-version: 1.25.x
        cache-dependency-path: |
          **/go.sum
          **/go.mod
    - name: Setup QEMU
      uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0
    - name: Setup Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
    - name: Run tests
      run: make test
    - name: Verify
      run: make verify
    - name: Build multi-arch container image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        push: false
        builder: ${{ steps.buildx.outputs.name }}
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm/v7,linux/arm64
        tags: |
          ${{ github.repository }}:latest
